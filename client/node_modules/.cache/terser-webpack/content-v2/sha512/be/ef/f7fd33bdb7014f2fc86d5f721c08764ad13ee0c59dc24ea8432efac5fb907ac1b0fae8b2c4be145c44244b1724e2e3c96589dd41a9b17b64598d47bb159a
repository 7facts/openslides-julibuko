{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{\"30jZ\":function(module,__webpack_exports__,__webpack_require__){\"use strict\";__webpack_require__.d(__webpack_exports__,\"a\",(function(){return getRecommendationTypeName}));var app_core_ui_services_diff_service__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(\"4X/P\");function getRecommendationTypeName(change){switch(change.type){case app_core_ui_services_diff_service__WEBPACK_IMPORTED_MODULE_0__.b.TYPE_REPLACEMENT:return\"Replacement\";case app_core_ui_services_diff_service__WEBPACK_IMPORTED_MODULE_0__.b.TYPE_INSERTION:return\"Insertion\";case app_core_ui_services_diff_service__WEBPACK_IMPORTED_MODULE_0__.b.TYPE_DELETION:return\"Deletion\";default:return change.other_description}}},BBYV:function(module,__webpack_exports__,__webpack_require__){\"use strict\";__webpack_require__.d(__webpack_exports__,\"a\",(function(){return HtmlToPdfService}));var app_site_motions_motions_constants__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(\"3Y4h\"),_angular_core__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(\"fXoL\");let HtmlToPdfService=(()=>{class HtmlToPdfService{constructor(){this.LI_MARGIN_BOTTOM=8,this.LINE_HEIGHT=1.25,this.P_MARGIN_BOTTOM=4,this.H_MARGIN_TOP=10,this.elementStyles={b:[\"font-weight:bold\"],strong:[\"font-weight:bold\"],u:[\"text-decoration:underline\"],em:[\"font-style:italic\"],i:[\"font-style:italic\"],h1:[\"font-size:14\",\"font-weight:bold\"],h2:[\"font-size:12\",\"font-weight:bold\"],h3:[\"font-size:10\",\"font-weight:bold\"],h4:[\"font-size:10\",\"font-style:italic\"],h5:[\"font-size:10\"],h6:[\"font-size:10\"],a:[\"color:blue\",\"text-decoration:underline\"],strike:[\"text-decoration:line-through\"],del:[\"color:red\",\"text-decoration:line-through\"],ins:[\"color:green\",\"text-decoration:underline\"]},this.classStyles={delete:[\"color:red\",\"text-decoration:line-through\"],insert:[\"color:green\",\"text-decoration:underline\"],paragraphcontext:[\"color:grey\"]}}getMarginTop(nodeName){switch(nodeName){case\"h1\":case\"h2\":case\"h3\":case\"h4\":case\"h5\":case\"h6\":return this.H_MARGIN_TOP;default:return 0}}getMarginBottom(nodeName){switch(nodeName){case\"h1\":case\"h2\":case\"h3\":case\"h4\":case\"h5\":case\"h6\":case\"li\":default:return this.P_MARGIN_BOTTOM}}addPlainText(text){return{columns:[{stack:this.convertHtml(text,app_site_motions_motions_constants__WEBPACK_IMPORTED_MODULE_0__.d.None)}]}}convertHtml(htmlText,lnMode){const docDef=[];this.lineNumberingMode=lnMode||app_site_motions_motions_constants__WEBPACK_IMPORTED_MODULE_0__.d.None;const parsedHtml=(new DOMParser).parseFromString(htmlText,\"text/html\"),htmlArray=Array.from(parsedHtml.body.childNodes);for(const child of htmlArray){const parsedElement=this.parseElement(child);docDef.push(parsedElement)}return docDef}parseElement(element,styles){const nodeName=element.nodeName.toLowerCase();let newParagraph,classes=[];if(styles=styles||[],element.getAttribute){const nodeStyle=element.getAttribute(\"style\"),nodeClass=element.getAttribute(\"class\");if(nodeStyle&&(styles=nodeStyle.split(\";\").map(style=>style.replace(/\\s/g,\"\")).concat(styles)),nodeClass){classes=nodeClass.toLowerCase().split(\" \");for(const cssClass of classes)this.classStyles[cssClass]&&this.classStyles[cssClass].forEach(style=>{styles.push(style)})}}switch(nodeName){case\"h1\":case\"h2\":case\"h3\":case\"h4\":case\"h5\":case\"h6\":case\"li\":case\"p\":case\"div\":{const children=this.parseChildren(element,styles);this.lineNumberingMode!==app_site_motions_motions_constants__WEBPACK_IMPORTED_MODULE_0__.d.Outside||classes.includes(\"insert\")?(newParagraph=this.create(\"text\"),newParagraph.text=children):(newParagraph=this.create(\"stack\"),newParagraph.stack=children),newParagraph.margin=[0,0,0,0],newParagraph.margin[1]=this.getMarginTop(nodeName),newParagraph.margin[3]=this.getMarginBottom(nodeName),this.lineNumberingMode===app_site_motions_motions_constants__WEBPACK_IMPORTED_MODULE_0__.d.Outside&&classes.includes(\"insert\")&&(newParagraph.margin[0]=20,newParagraph.margin[3]=this.P_MARGIN_BOTTOM),classes.includes(\"os-split-before\")&&(newParagraph.listType=\"none\"),(classes.includes(\"os-split-after\")||this.withSublist(element))&&(newParagraph.margin[3]=0),newParagraph.lineHeight=this.LINE_HEIGHT,newParagraph=Object.assign(Object.assign(Object.assign({},newParagraph),this.computeStyle(styles)),this.computeStyle(this.elementStyles[nodeName]));break}case\"a\":case\"b\":case\"strong\":case\"u\":case\"em\":case\"i\":case\"ins\":case\"del\":case\"strike\":{const children=this.parseChildren(element,styles.concat(this.elementStyles[nodeName]));newParagraph=this.create(\"text\"),newParagraph.text=children;break}case\"span\":if(element.getAttribute(\"data-line-number\")&&!this.isInsideAList(element)){if(this.lineNumberingMode===app_site_motions_motions_constants__WEBPACK_IMPORTED_MODULE_0__.d.Inside);else if(this.lineNumberingMode===app_site_motions_motions_constants__WEBPACK_IMPORTED_MODULE_0__.d.Outside){const currentLineNumber=element.getAttribute(\"data-line-number\");newParagraph={columns:[this.getLineNumberObject({lineNumber:+currentLineNumber}),{text:[]}]}}}else{const children=this.parseChildren(element,styles);newParagraph=Object.assign(Object.assign({},this.create(\"text\")),this.computeStyle(styles)),newParagraph.text=children}break;case\"br\":if(this.lineNumberingMode===app_site_motions_motions_constants__WEBPACK_IMPORTED_MODULE_0__.d.None&&classes.includes(\"os-line-break\")||this.lineNumberingMode===app_site_motions_motions_constants__WEBPACK_IMPORTED_MODULE_0__.d.Outside&&this.isInsideAList(element))break;newParagraph=this.create(\"text\"),newParagraph.text=\"\\n\",newParagraph.lineHeight=this.LINE_HEIGHT;break;case\"ul\":case\"ol\":{const list=this.create(nodeName);if(\"ol\"===nodeName){const start=element.getAttribute(\"start\");start&&(list.start=parseInt(start,10))}if(this.lineNumberingMode===app_site_motions_motions_constants__WEBPACK_IMPORTED_MODULE_0__.d.Outside){const lines=this.extractLineNumbers(element),cleanedChildDom=this.cleanLineNumbers(element),cleanedChildren=this.parseChildren(cleanedChildDom,styles);if(lines.length>0){const listCol={columns:[{width:20,stack:[]}],margin:[0,0,0,0]};this.isFakeList(element)&&(listCol.margin[3]=-this.LI_MARGIN_BOTTOM);for(const line of lines)listCol.columns[0].stack.push(this.getLineNumberObject(line));list[nodeName]=cleanedChildren,listCol.columns.push(list),newParagraph=listCol}else list.margin=[20,0,0,0],newParagraph=list,newParagraph[nodeName]=cleanedChildren}else{const children=this.parseChildren(element,styles);newParagraph=list,newParagraph[nodeName]=children}break}default:newParagraph=Object.assign(Object.assign({},this.create(\"text\",element.textContent.replace(/\\n/g,\"\"))),this.computeStyle(styles))}return newParagraph}parseChildren(element,styles){const childNodes=Array.from(element.childNodes),paragraph=[];if(childNodes.length>0)for(const child of childNodes)if(\"#text\"!==child.nodeName||\"\"!==child.textContent.trim()){const parsedElement=this.parseElement(child,styles),firstChild=element.firstChild;if(this.lineNumberingMode===app_site_motions_motions_constants__WEBPACK_IMPORTED_MODULE_0__.d.Outside&&child&&child.classList&&child.classList.contains(\"os-line-number\"))paragraph.push(parsedElement);else if(this.lineNumberingMode===app_site_motions_motions_constants__WEBPACK_IMPORTED_MODULE_0__.d.Outside&&firstChild&&firstChild.classList&&firstChild.classList.contains(\"os-line-number\")){const currentLine=paragraph.pop();currentLine.columns[1].text.push(parsedElement),paragraph.push(currentLine)}else paragraph.push(parsedElement)}return paragraph}getLineNumberObject(line){return{width:20,text:[{text:\" \",fontSize:10,decoration:\"\"},{text:line.lineNumber,color:\"gray\",fontSize:8}],marginBottom:line.marginBottom,lineHeight:this.LINE_HEIGHT}}withSublist(element){return\"li\"===element.nodeName.toLowerCase()&&Array.from(element.children).some(child=>\"ul\"===child.nodeName.toLowerCase())}cleanLineNumbers(element){const elementCopy=element.cloneNode(!0),children=elementCopy.childNodes;for(let i=0;i<children.length;i++)if(this.getLineNumber(children[i])&&children[i].remove(),children[i].childNodes.length>0){const cleanChildren=this.cleanLineNumbers(children[i]);elementCopy.replaceChild(cleanChildren,children[i])}return elementCopy}extractLineNumbers(element){let foundLineNumbers=[];const lineNumber=this.getLineNumber(element);if(lineNumber)foundLineNumbers.push({lineNumber:lineNumber});else if(\"BR\"===element.nodeName)this.getLineNumber(element.nextSibling)||foundLineNumbers.push({lineNumber:\"\"});else{const children=Array.from(element.childNodes);let childrenLength=children.length,childrenLineNumbers=[];for(let i=0;i<children.length;i++)childrenLineNumbers=childrenLineNumbers.concat(this.extractLineNumbers(children[i])),children.length<childrenLength&&(i-=childrenLength-children.length,childrenLength=children.length);childrenLineNumbers.length&&\"LI\"===element.nodeName?childrenLineNumbers[childrenLineNumbers.length-1].marginBottom=this.LI_MARGIN_BOTTOM:childrenLineNumbers.length&&\"LI\"===element.parentNode.nodeName&&(childrenLineNumbers[childrenLineNumbers.length-1].marginBottom=this.P_MARGIN_BOTTOM),foundLineNumbers=foundLineNumbers.concat(childrenLineNumbers)}return foundLineNumbers}isInsideAList(element){let parent=element.parentNode;for(;null!==parent;){if(\"UL\"===parent.nodeName||\"OL\"===parent.nodeName)return!0;parent=parent.parentNode}return!1}isFakeList(element){if(element.firstElementChild&&element.classList.contains(\"os-split-after\")){const firstChild=element.firstElementChild,lastChild=element.childNodes[element.childNodes.length-1],splitBefore=\"LI\"===firstChild.nodeName&&firstChild.classList.contains(\"os-split-before\"),splitAfter=\"LI\"===lastChild.nodeName&&lastChild.classList.contains(\"os-split-after\");return splitBefore||splitAfter}return!1}getLineNumber(element){if(element&&\"SPAN\"===element.nodeName&&element.getAttribute(\"class\")&&element.getAttribute(\"class\").indexOf(\"os-line-number\")>-1)return parseInt(element.getAttribute(\"data-line-number\"),10)}computeStyle(styles){const styleObject={};if(styles&&styles.length>0)for(const style of styles){const styleDefinition=style.trim().toLowerCase().split(\":\"),key=styleDefinition[0],value=styleDefinition[1];if(2===styleDefinition.length)switch(key){case\"padding-left\":styleObject.margin=[parseInt(value,10),0,0,0];break;case\"font-size\":styleObject.fontSize=parseInt(value,10);break;case\"text-align\":switch(value){case\"right\":case\"center\":case\"justify\":styleObject.alignment=value}break;case\"font-weight\":switch(value){case\"bold\":styleObject.bold=!0}break;case\"text-decoration\":switch(value){case\"underline\":styleObject.decoration=\"underline\";break;case\"line-through\":styleObject.decoration=\"lineThrough\"}break;case\"font-style\":switch(value){case\"italic\":styleObject.italics=!0}break;case\"color\":styleObject.color=this.parseColor(value);break;case\"background-color\":styleObject.background=this.parseColor(value)}}return styleObject}parseColor(color){const haxRegex=new RegExp(\"^#([0-9a-f]{3}|[0-9a-f]{6})$\"),rgbRegex=new RegExp(\"^rgb\\\\((\\\\d+),\\\\s*(\\\\d+),\\\\s*(\\\\d+)\\\\)$\"),nameRegex=new RegExp(\"^[a-z]+$\");if(haxRegex.test(color))return color;if(rgbRegex.test(color)){const decimalColors=rgbRegex.exec(color).slice(1);for(let i=0;i<3;i++){let decimalValue=parseInt(decimalColors[i],10);decimalValue>255&&(decimalValue=255);let hexString=\"0\"+decimalValue.toString(16);hexString=hexString.slice(-2),decimalColors[i]=hexString}return\"#\"+decimalColors.join(\"\")}return nameRegex.test(color)||console.error('Could not parse color \"'+color+'\"'),color}create(name,content){const container={};return container[name]=content||[],container}}return HtmlToPdfService.ɵfac=function(t){return new(t||HtmlToPdfService)},HtmlToPdfService.ɵprov=_angular_core__WEBPACK_IMPORTED_MODULE_1__.Pb({token:HtmlToPdfService,factory:HtmlToPdfService.ɵfac,providedIn:\"root\"}),HtmlToPdfService})()},y50V:function(module,__webpack_exports__,__webpack_require__){\"use strict\";__webpack_require__.d(__webpack_exports__,\"a\",(function(){return motion_pdf_export_service_MotionPdfExportService}));var html_to_pdf_service=__webpack_require__(\"BBYV\"),motion_repository_service=__webpack_require__(\"dOok\"),core=__webpack_require__(\"fXoL\"),ngx_translate_core=__webpack_require__(\"sYmb\");let amendment_list_pdf_service_AmendmentListPdfService=(()=>{class AmendmentListPdfService{constructor(motionRepo,translate,htmlToPdfService){this.motionRepo=motionRepo,this.translate=translate,this.htmlToPdfService=htmlToPdfService}renderDiffLines(amendment){if(amendment.diffLines&&amendment.diffLines.length){const linesHtml=amendment.diffLines.map(line=>line.text).join(\"<br />[...]<br />\");return this.htmlToPdfService.convertHtml(linesHtml)}}amendmentToTableRow(amendment){let recommendationText=\"\";return amendment.recommendation&&(recommendationText+=amendment.recommendation.show_recommendation_extension_field&&amendment.recommendationExtension?\" \"+this.motionRepo.getExtendedRecommendationLabel(amendment):this.translate.instant(amendment.recommendation.recommendation_label)),[{text:amendment.identifierOrTitle},{text:amendment.getChangeLines()},{text:amendment.submittersAsUsers.toString()},{stack:this.renderDiffLines(amendment)},{text:recommendationText}]}overviewToDocDef(docTitle,amendments){const title={text:docTitle,style:\"title\"},amendmentTableBody=[[{text:this.translate.instant(\"Motion\"),style:\"tableHeader\"},{text:this.translate.instant(\"Line\"),style:\"tableHeader\"},{text:this.translate.instant(\"Submitters\"),style:\"tableHeader\"},{text:this.translate.instant(\"Changes\"),style:\"tableHeader\"},{text:this.translate.instant(\"Recommendation\"),style:\"tableHeader\"}]],amendmentRows=[];for(const amendment of amendments)amendmentRows.push(this.amendmentToTableRow(amendment));return[title,{table:{widths:[\"auto\",\"auto\",\"auto\",\"*\",\"auto\"],headerRows:1,dontBreakRows:!0,body:amendmentTableBody.concat(amendmentRows)},layout:\"switchColorTableLayout\"}]}}return AmendmentListPdfService.ɵfac=function(t){return new(t||AmendmentListPdfService)(core.dc(motion_repository_service.a),core.dc(ngx_translate_core.k),core.dc(html_to_pdf_service.a))},AmendmentListPdfService.ɵprov=core.Pb({token:AmendmentListPdfService,factory:AmendmentListPdfService.ɵfac,providedIn:\"root\"}),AmendmentListPdfService})();var pdf_document_service=__webpack_require__(\"a9GI\"),config_service=__webpack_require__(\"+KbT\"),category_repository_service=__webpack_require__(\"iTQr\"),change_recommendation_repository_service=__webpack_require__(\"pSLD\"),motion_comment_section_repository_service=__webpack_require__(\"+B0n\"),statute_paragraph_repository_service=__webpack_require__(\"Mluu\"),linenumbering_service=__webpack_require__(\"a9XT\"),view_unified_change=__webpack_require__(\"GEzB\"),parse_poll_number_pipe=__webpack_require__(\"j7f2\"),poll_key_verbose_pipe=__webpack_require__(\"6ako\"),recommendation_type_names=__webpack_require__(\"30jZ\"),motion_poll_service=__webpack_require__(\"ykax\"),motions_constants=__webpack_require__(\"3Y4h\");let motion_pdf_service_MotionPdfService=(()=>{class MotionPdfService{constructor(translate,motionRepo,statuteRepo,changeRecoRepo,configService,pdfDocumentService,htmlToPdfService,linenumberingService,commentRepo,pollKeyVerbose,parsePollNumber,motionPollService){this.translate=translate,this.motionRepo=motionRepo,this.statuteRepo=statuteRepo,this.changeRecoRepo=changeRecoRepo,this.configService=configService,this.pdfDocumentService=pdfDocumentService,this.htmlToPdfService=htmlToPdfService,this.linenumberingService=linenumberingService,this.commentRepo=commentRepo,this.pollKeyVerbose=pollKeyVerbose,this.parsePollNumber=parsePollNumber,this.motionPollService=motionPollService,this.getRecommendationTypeName=recommendation_type_names.a}motionToDocDef(motion,exportInfo){let lnMode=exportInfo&&exportInfo.lnMode?exportInfo.lnMode:null,crMode=exportInfo&&exportInfo.crMode?exportInfo.crMode:null;const infoToExport=exportInfo?exportInfo.metaInfo:null,contentToExport=exportInfo?exportInfo.content:null;let commentsToExport=exportInfo?exportInfo.comments:null;const lineLength=this.configService.instant(\"motions_line_length\"),optionToFollowRecommendation=this.configService.instant(\"motions_export_follow_recommendation\");let motionPdfContent=[];motion.isStatuteAmendment()&&(lnMode=motions_constants.d.None,crMode=motions_constants.b.Diff),lnMode||(lnMode=this.configService.instant(\"motions_default_line_numbering\")),crMode||(crMode=this.configService.instant(\"motions_recommendation_text_mode\"));const title=this.createTitle(motion,crMode,lineLength),sequential=!infoToExport||infoToExport.includes(\"id\");if(motionPdfContent=[title,this.createSubtitle(motion,sequential)],infoToExport&&infoToExport.length>0||!infoToExport){const metaInfo=this.createMetaInfoTable(motion,lineLength,crMode,infoToExport,optionToFollowRecommendation);motionPdfContent.push(metaInfo)}if(!contentToExport||contentToExport.includes(\"text\")){const preamble=this.createPreamble(motion);motionPdfContent.push(preamble);const text=this.createText(motion,lineLength,lnMode,crMode);motionPdfContent.push(text)}if(!contentToExport||contentToExport.includes(\"reason\")){const reason=this.createReason(motion,lnMode);motionPdfContent.push(reason)}return infoToExport&&infoToExport.includes(\"allcomments\")&&(commentsToExport=this.commentRepo.getViewModelList().map(vm=>vm.id)),commentsToExport&&motionPdfContent.push(this.createComments(motion,commentsToExport)),motionPdfContent}createTitle(motion,crMode,lineLength){const titleChange=this.getUnifiedChanges(motion,lineLength).find(change=>change.isTitleChange()),changedTitle=this.changeRecoRepo.getTitleWithChanges(motion.title,titleChange,crMode),identifier=motion.identifier?\" \"+motion.identifier:\"\";let title=\"\";return\"A4\"===this.configService.instant(\"general_export_pdf_pagesize\")&&(title+=this.translate.instant(\"Motion\")+\" \"),title+=`${identifier}: ${changedTitle}`,{text:title,style:\"title\"}}createSubtitle(motion,sequential){const subtitleLines=[];return sequential&&subtitleLines.push(`${this.translate.instant(\"Sequential number\")}: ${motion.id}`),motion.parent_id&&(sequential&&subtitleLines.push(\" • \"),subtitleLines.push(`${this.translate.instant(\"Amendment to\")} ${motion.parent.identifier||motion.parent.title}`)),{text:subtitleLines,style:\"subtitle\"}}createMetaInfoTable(motion,lineLength,crMode,infoToExport,optionToFollowRecommendation){const metaTableBody=[];if(!infoToExport||infoToExport.includes(\"submitters\")){const submitters=motion.submittersAsUsers.map(user=>user.full_name).join(\", \");metaTableBody.push([{text:this.translate.instant(\"Submitters\")+\":\",style:\"boldText\"},{text:submitters}])}if(this.configService.instant(\"motions_min_supporters\")&&motion.supporters.length>0){const supporters=motion.supporters.map(supporter=>supporter.full_name).join(\", \");metaTableBody.push([{text:this.translate.instant(\"Supporters\")+\":\",style:\"boldText\"},{text:supporters}])}if(infoToExport&&!infoToExport.includes(\"state\")||metaTableBody.push([{text:this.translate.instant(\"State\")+\":\",style:\"boldText\"},{text:this.motionRepo.getExtendedStateLabel(motion)}]),motion.recommendation&&(!infoToExport||infoToExport.includes(\"recommendation\"))){let recommendationByText;recommendationByText=motion.isStatuteAmendment()?this.configService.instant(\"motions_statute_recommendations_by\"):this.configService.instant(\"motions_recommendations_by\"),metaTableBody.push([{text:recommendationByText+\":\",style:\"boldText\"},{text:this.motionRepo.getExtendedRecommendationLabel(motion)}])}if(motion.category&&(!infoToExport||infoToExport.includes(\"category\"))){let categoryText=\"\";categoryText=motion.category.parent?`${motion.category.parent.toString()}\\n${this.translate.instant(\"Subcategory\")}: ${motion.category.toString()}`:motion.category.toString(),metaTableBody.push([{text:this.translate.instant(\"Category\")+\":\",style:\"boldText\"},{text:categoryText}])}if(motion.tags.length&&(!infoToExport||infoToExport.includes(\"tags\"))){const tags=motion.tags.map(tag=>tag).join(\", \");metaTableBody.push([{text:this.translate.instant(\"Tags\")+\":\",style:\"boldText\"},{text:tags}])}if(!motion.motion_block||infoToExport&&!infoToExport.includes(\"motion_block\")||metaTableBody.push([{text:this.translate.instant(\"Motion block\")+\":\",style:\"boldText\"},{text:motion.motion_block.title}]),!motion.origin||infoToExport&&!infoToExport.includes(\"origin\")||metaTableBody.push([{text:this.translate.instant(\"Origin\")+\":\",style:\"boldText\"},{text:motion.origin}]),motion.polls.length&&(!infoToExport||infoToExport.includes(\"polls\"))){const column1=[],column2=[],column3=[];motion.polls.forEach(poll=>{poll.hasVotes&&this.motionPollService.generateTableData(poll).forEach(votingResult=>{const votingOption=this.translate.instant(this.pollKeyVerbose.transform(votingResult.votingOption)),value=votingResult.value[0],resultValue=this.parsePollNumber.transform(value.amount);if(column1.push(votingOption+\":\"),value.showPercent){const resultInPercent=this.motionPollService.getVoteValueInPercent(value.amount,poll);column2.push(null!==resultInPercent?`(${resultInPercent})`:\"\")}else column2.push(\"\");column3.push(resultValue)})}),metaTableBody.push([{text:this.translate.instant(\"Voting result\")+\":\",style:\"boldText\"},{columns:[{text:column1.join(\"\\n\"),width:\"auto\"},{text:column2.join(\"\\n\"),width:\"auto\",alignment:\"right\"},{text:column3.join(\"\\n\"),width:\"auto\",alignment:\"right\"}],columnGap:7}])}const changes=this.getUnifiedChanges(motion,lineLength);if(crMode===motions_constants.b.Diff&&changes.length>0){const columnLineNumbers=[],columnChangeType=[];changes.forEach(change=>{if(change.isTitleChange()){const changeReco=change;columnLineNumbers.push(this.translate.instant(\"Title\")+\": \"),columnChangeType.push(`(${this.translate.instant(\"Change recommendation\")}) - ${this.translate.instant(this.getRecommendationTypeName(changeReco))}`)}else{let line;if(line=change.getLineFrom()>=change.getLineTo()-1?change.getLineFrom():change.getLineFrom()+\" - \"+(change.getLineTo()-1),change.getChangeType()===view_unified_change.a.TYPE_CHANGE_RECOMMENDATION){const changeReco=change;columnLineNumbers.push(`${this.translate.instant(\"Line\")} ${line}: `),columnChangeType.push(`(${this.translate.instant(\"Change recommendation\")}) - ${this.translate.instant(this.getRecommendationTypeName(changeReco))}`)}else if(change.getChangeType()===view_unified_change.a.TYPE_AMENDMENT){const amendment=change;let summaryText=`(${this.translate.instant(\"Amendment\")} ${amendment.getIdentifier()}) -`;amendment.isRejected()?summaryText+=\" \"+this.translate.instant(\"Rejected\"):amendment.isAccepted()&&(summaryText+=\" \"+this.translate.instant(amendment.stateName),columnLineNumbers.push(`${this.translate.instant(\"Line\")} ${line}: `),columnChangeType.push(summaryText))}}}),columnChangeType.length>0&&metaTableBody.push([{text:this.translate.instant(\"Summary of changes:\"),style:\"boldText\"},{columns:[{text:columnLineNumbers.join(\"\\n\"),width:\"auto\"},{text:columnChangeType.join(\"\\n\"),width:\"auto\"}],columnGap:7}])}if(optionToFollowRecommendation&&metaTableBody.push([{text:this.translate.instant(\"Decision\")+\":\",style:\"boldText\"},{margin:[5,2,0,2],columns:[{width:8,canvas:this.pdfDocumentService.drawCircle(6.5,4)},{width:\"auto\",text:this.translate.instant(\"As recommendation\")},{width:20,text:\"\"},{width:8,canvas:this.pdfDocumentService.drawCircle(6.5,4)},{width:\"auto\",text:this.translate.instant(\"Divergent:\")}]}]),metaTableBody.length>0)return{table:{widths:[\"35%\",\"65%\"],body:metaTableBody},margin:[0,0,0,20],layout:\"metaboxLayout\"}}createPreamble(motion){const motions_preamble=this.configService.instant(\"motions_preamble\");return{text:\"\"+this.translate.instant(motions_preamble),margin:[0,10,0,10]}}createText(motion,lineLength,lnMode,crMode){let motionText=\"\";if(motion.isParagraphBasedAmendment()){const changeRecos=this.changeRecoRepo.getChangeRecoOfMotion(motion.id),amendmentParas=this.motionRepo.getAmendmentParagraphLines(motion,lineLength,crMode,changeRecos,!1);for(const paragraph of amendmentParas)motionText+=\"<h3>\"+this.motionRepo.getAmendmentParagraphLinesTitle(paragraph)+\"</h3>\",motionText+=`<div class=\"paragraphcontext\">${paragraph.textPre}</div>`,motionText+=paragraph.text,motionText+=`<div class=\"paragraphcontext\">${paragraph.textPost}</div>`}else if(motion.isStatuteAmendment()){const statutes=this.statuteRepo.getViewModelList();motionText=this.motionRepo.formatStatuteAmendment(statutes,motion,lineLength)}else{const changes=this.getUnifiedChanges(motion,lineLength),textChanges=changes.filter(change=>!change.isTitleChange()),titleChange=changes.find(change=>change.isTitleChange());if(crMode===motions_constants.b.Diff&&titleChange){const changedTitle=this.changeRecoRepo.getTitleChangesAsDiff(motion.title,titleChange);motionText+=\"<span><strong>\"+this.translate.instant(\"Changed title\")+\":</strong><br>\"+changedTitle+\"</span><br>\"}const formattedText=this.motionRepo.formatMotion(motion.id,crMode,textChanges,lineLength);motionText+=this.linenumberingService.splitInlineElementsAtLineBreaks(formattedText)}return this.htmlToPdfService.convertHtml(motionText,lnMode)}getUnifiedChanges(motion,lineLength){const changeRecosOfMotion=this.changeRecoRepo.getChangeRecoOfMotion(motion.id);return changeRecosOfMotion&&changeRecosOfMotion.length?changeRecosOfMotion.concat(this.motionRepo.getAmendmentsInstantly(motion.id).flatMap(amendment=>{const changeRecos=this.changeRecoRepo.getChangeRecoOfMotion(amendment.id).filter(reco=>reco.showInFinalView());if(changeRecos&&changeRecos.length)return this.motionRepo.getAmendmentAmendedParagraphs(amendment,lineLength,changeRecos)})).sort((a,b)=>a.getLineFrom()-b.getLineFrom()):[]}createReason(motion,lnMode){if(motion.reason){const reason=[];return reason.push({text:this.translate.instant(\"Reason\"),style:\"heading3\",margin:[0,25,0,10]}),reason.push(this.htmlToPdfService.addPlainText(motion.reason)),reason}return{}}callListToDoc(motions){motions.sort((a,b)=>a.weight-b.weight);const title={text:this.translate.instant(\"Call list\"),style:\"title\"},callListTableBody=[[{text:this.translate.instant(\"Called\"),style:\"tableHeader\"},{text:this.translate.instant(\"Called with\"),style:\"tableHeader\"},{text:this.translate.instant(\"Submitters\"),style:\"tableHeader\"},{text:this.translate.instant(\"Title\"),style:\"tableHeader\"},{text:this.translate.instant(\"Recommendation\"),style:\"tableHeader\"},{text:this.translate.instant(\"Notes\"),style:\"tableHeader\"}]],callListRows=[];let currentTitle=\"\";return motions.forEach(motion=>{if(!motion.sort_parent_id){const heading=motion.tags?motion.tags.map(tag=>tag.name).join(\", \"):\"\";heading!==currentTitle&&(callListRows.push([{text:heading,colSpan:6,style:\"heading3\",margin:[0,10,0,10]},\"\",\"\",\"\",\"\",\"\"]),currentTitle=heading)}callListRows.push(this.createCallListRow(motion))}),[title,{table:{widths:[\"auto\",\"auto\",\"auto\",\"*\",\"auto\",\"auto\"],headerRows:1,dontBreakRows:!0,body:callListTableBody.concat(callListRows)},layout:\"switchColorTableLayout\"}]}createCallListRow(motion){return[{text:motion.sort_parent_id?\"\":motion.identifierOrTitle},{text:motion.sort_parent_id?motion.identifierOrTitle:\"\"},{text:motion.submitters.length?motion.submittersAsUsers.map(s=>s.short_name).join(\", \"):\"\"},{text:motion.title},{text:motion.recommendation?this.motionRepo.getExtendedRecommendationLabel(motion):\"\"},{text:\"\"}]}textToDocDef(note,motion,noteTitle){const lineLength=this.configService.instant(\"motions_line_length\"),crMode=this.configService.instant(\"motions_recommendation_text_mode\"),title=this.createTitle(motion,crMode,lineLength),subtitle=this.createSubtitle(motion),metaInfo=this.createMetaInfoTable(motion,lineLength,crMode,[\"submitters\",\"state\",\"category\"]),noteContent=this.htmlToPdfService.convertHtml(note,motions_constants.d.None);return[title,subtitle,metaInfo,{text:this.translate.instant(noteTitle),style:\"heading2\"},noteContent]}createComments(motion,comments){const result=[];for(const comment of comments){let name=\"\",content=\"\";if(comment===motions_constants.f)name=this.translate.instant(\"Personal note\"),content=motion&&motion.personalNote&&motion.personalNote.note;else{const viewComment=this.commentRepo.getViewModel(comment),section=motion.getCommentForSection(viewComment);name=viewComment.name,content=section&&section.comment}name&&content&&(result.push({text:name,style:\"heading3\",margin:[0,25,0,10]}),result.push(this.htmlToPdfService.addPlainText(content)))}return result}}return MotionPdfService.ɵfac=function(t){return new(t||MotionPdfService)(core.dc(ngx_translate_core.k),core.dc(motion_repository_service.a),core.dc(statute_paragraph_repository_service.a),core.dc(change_recommendation_repository_service.a),core.dc(config_service.a),core.dc(pdf_document_service.b),core.dc(html_to_pdf_service.a),core.dc(linenumbering_service.a),core.dc(motion_comment_section_repository_service.a),core.dc(poll_key_verbose_pipe.a),core.dc(parse_poll_number_pipe.a),core.dc(motion_poll_service.a))},MotionPdfService.ɵprov=core.Pb({token:MotionPdfService,factory:MotionPdfService.ɵfac,providedIn:\"root\"}),MotionPdfService})(),motion_pdf_catalog_service_MotionPdfCatalogService=(()=>{class MotionPdfCatalogService{constructor(translate,configService,motionPdfService,pdfService,motionRepo,categoryRepo){this.translate=translate,this.configService=configService,this.motionPdfService=motionPdfService,this.pdfService=pdfService,this.motionRepo=motionRepo,this.categoryRepo=categoryRepo,this.categoryObserver=this.categoryRepo.getViewModelListBehaviorSubject()}motionListToDocDef(motions,exportInfo){let doc=[];const motionDocList=[],printToc=exportInfo.pdfOptions.includes(\"toc\"),enforcePageBreaks=exportInfo.pdfOptions.includes(\"addBreaks\");for(let motionIndex=0;motionIndex<motions.length;++motionIndex)try{const motionDocDef=this.motionPdfService.motionToDocDef(motions[motionIndex],exportInfo);motionDocDef[0].id=\"\"+motions[motionIndex].id,motionDocList.push(motionDocDef),motionIndex<motions.length-1&&enforcePageBreaks?motionDocList.push(this.pdfService.getPageBreak()):motionIndex<motions.length-1&&!enforcePageBreaks&&motionDocList.push(this.pdfService.getSpacer())}catch(err){const errorText=`${this.translate.instant(\"Error during PDF creation of motion:\")} ${motions[motionIndex].identifierOrTitle}`;throw console.error(errorText+\"\\nDebugInfo:\\n\",err),new pdf_document_service.c(errorText)}return motions.length>1&&(!exportInfo.pdfOptions||printToc)&&doc.push(this.pdfService.createTitle(\"motions_export_title\"),this.pdfService.createPreamble(\"motions_export_preamble\"),this.createToc(motions)),doc=doc.concat(motionDocList),doc}createToc(motions,sorting){const toc=[],categories=this.categoryObserver.value,tocTitle={text:this.translate.instant(\"Table of contents\"),style:\"heading2\"},exportSubmitterRecommendation=this.configService.instant(\"motions_export_submitter_recommendation\"),header=exportSubmitterRecommendation?this.getTocHeaderDefinition():void 0,layout=exportSubmitterRecommendation?pdf_document_service.a.LIGHT_HORIZONTAL_LINES:pdf_document_service.a.DEFAULT;if(categories&&categories.length){const catTocBody=[];for(const category of categories.sort((a,b)=>a.weight-b.weight)){const motionToCurrentCat=motions.filter(motionIn=>category===motionIn.category);if(motionToCurrentCat&&motionToCurrentCat.length){catTocBody.length&&catTocBody.push(this.pdfService.getPageBreak()),catTocBody.push({table:{body:[[{text:category.nameWithParentAbove,style:category.parent?\"tocSubcategoryTitle\":\"tocCategoryTitle\"}]]},layout:exportSubmitterRecommendation?\"lightHorizontalLines\":\"noBorders\"});const tocBody=[];for(const motion of motionToCurrentCat)tocBody.push(exportSubmitterRecommendation?this.appendSubmittersAndRecommendation(motion,pdf_document_service.d.CATEGORY_SECTION):this.pdfService.createTocLine(\"\"+(motion.identifier?motion.identifier:\"\"),motion.title,\"\"+motion.id,pdf_document_service.d.CATEGORY_SECTION));catTocBody.push(this.pdfService.createTocTableDef(tocBody,pdf_document_service.d.CATEGORY_SECTION,layout,header?JSON.parse(JSON.stringify(header)):null))}}const uncatTocBody=motions.filter(motion=>!motion.category).map(motion=>this.pdfService.createTocLine(\"\"+(motion.identifier?motion.identifier:\"\"),motion.title,\"\"+motion.id));uncatTocBody.length>0&&(catTocBody.push(this.pdfService.getPageBreak()),catTocBody.push(this.pdfService.createTocTableDef(uncatTocBody,pdf_document_service.d.CATEGORY_SECTION))),toc.push(catTocBody)}else{const tocBody=[];for(const motion of motions)tocBody.push(exportSubmitterRecommendation?this.appendSubmittersAndRecommendation(motion):this.pdfService.createTocLine(\"\"+(motion.identifier?motion.identifier:\"\"),motion.title,\"\"+motion.id));toc.push(this.pdfService.createTocTableDef(tocBody,pdf_document_service.d.CATEGORY_SECTION,layout,header))}return[tocTitle,toc,this.pdfService.getPageBreak()]}getTocHeaderDefinition(){return[{text:this.translate.instant(\"Identifier\"),style:\"tocHeaderRow\"},{style:\"tocHeaderRow\",text:[`${this.translate.instant(\"Title\")} · ${this.translate.instant(\"Submitters\")} · `,{text:\"\"+this.translate.instant(\"Recommendation\"),italics:!0}]},{text:this.translate.instant(\"Page\"),style:\"tocHeaderRow\",alignment:\"right\"}]}appendSubmittersAndRecommendation(motion,style=pdf_document_service.d.DEFAULT){let submitterList=\"\",state=\"\";state=motion.state.isFinalState?this.motionRepo.getExtendedStateLabel(motion):this.motionRepo.getExtendedRecommendationLabel(motion);for(let i=0;i<motion.submitters.length;++i)submitterList+=i!==motion.submitters.length-1?motion.submitters[i].getTitle()+\", \":motion.submitters[i].getTitle();return this.pdfService.createTocLine(\"\"+(motion.identifier?motion.identifier:\"\"),motion.title,\"\"+motion.id,style,this.pdfService.createTocLineInline(submitterList),this.pdfService.createTocLineInline(state,!0))}}return MotionPdfCatalogService.ɵfac=function(t){return new(t||MotionPdfCatalogService)(core.dc(ngx_translate_core.k),core.dc(config_service.a),core.dc(motion_pdf_service_MotionPdfService),core.dc(pdf_document_service.b),core.dc(motion_repository_service.a),core.dc(category_repository_service.a))},MotionPdfCatalogService.ɵprov=core.Pb({token:MotionPdfCatalogService,factory:MotionPdfCatalogService.ɵfac,providedIn:\"root\"}),MotionPdfCatalogService})(),motion_pdf_export_service_MotionPdfExportService=(()=>{class MotionPdfExportService{constructor(translate,configService,motionPdfService,amendmentListPdfService,pdfCatalogService,pdfDocumentService){this.translate=translate,this.configService=configService,this.motionPdfService=motionPdfService,this.amendmentListPdfService=amendmentListPdfService,this.pdfCatalogService=pdfCatalogService,this.pdfDocumentService=pdfDocumentService}exportSingleMotion(motion,exportInfo){const doc=this.motionPdfService.motionToDocDef(motion,exportInfo),filename=`${this.translate.instant(\"Motion\")} ${motion.identifierOrTitle}`;this.pdfDocumentService.download(doc,filename,{title:filename})}exportMotionCatalog(motions,exportInfo){const doc=this.pdfCatalogService.motionListToDocDef(motions,exportInfo),motions_export_title=this.configService.instant(\"motions_export_title\"),filename=this.translate.instant(motions_export_title);this.pdfDocumentService.download(doc,filename,{title:filename},exportInfo)}exportPdfCallList(motions){const doc=this.motionPdfService.callListToDoc(motions),filename=this.translate.instant(\"Call list\");this.pdfDocumentService.downloadLandscape(doc,filename,{title:filename})}exportPersonalNote(note,motion){const doc=this.motionPdfService.textToDocDef(note.note,motion,\"Personal note\"),filename=`${motion.identifierOrTitle} - ${this.translate.instant(\"Personal note\")}`;this.pdfDocumentService.download(doc,filename,{title:filename})}exportComment(comment,motion){const motionComment=motion.getCommentForSection(comment);if(motionComment&&motionComment.comment){const doc=this.motionPdfService.textToDocDef(motionComment.comment,motion,comment.name),filename=`${motion.identifierOrTitle} - ${comment.name}`;this.pdfDocumentService.download(doc,filename,{title:filename})}}exportAmendmentList(amendments,parentMotion){let filename;filename=parentMotion?`${this.translate.instant(\"Amendments to\")} ${parentMotion.getListTitle()}`:\"\"+this.translate.instant(\"Amendments\");const doc=this.amendmentListPdfService.overviewToDocDef(filename,amendments);this.pdfDocumentService.downloadLandscape(doc,filename,{title:filename})}}return MotionPdfExportService.ɵfac=function(t){return new(t||MotionPdfExportService)(core.dc(ngx_translate_core.k),core.dc(config_service.a),core.dc(motion_pdf_service_MotionPdfService),core.dc(amendment_list_pdf_service_AmendmentListPdfService),core.dc(motion_pdf_catalog_service_MotionPdfCatalogService),core.dc(pdf_document_service.b))},MotionPdfExportService.ɵprov=core.Pb({token:MotionPdfExportService,factory:MotionPdfExportService.ɵfac,providedIn:\"root\"}),MotionPdfExportService})()}}]);","extractedComments":[]}