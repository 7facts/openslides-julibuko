/**
 * @fileoverview added by tsickle
 * Generated from: lib/block-ui/block-ui-plugin.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { __decorate, __metadata } from "tslib";
import { isObservable } from 'rxjs';
import { Directive, Input } from '@angular/core';
import { coerceBooleanProperty } from '@angular/cdk/coercion';
import { UnRx } from '@pebula/utils';
import { PblNgridComponent, PblNgridPluginController, NgridPlugin } from '@pebula/ngrid';
/** @type {?} */
const PLUGIN_KEY = 'blockUi';
/**
 * @template T
 */
let PblNgridBlockUiPluginDirective = /**
 * @template T
 */
class PblNgridBlockUiPluginDirective {
    /**
     * @param {?} grid
     * @param {?} pluginCtrl
     */
    constructor(grid, pluginCtrl) {
        this.grid = grid;
        this._blockInProgress = false;
        this._removePlugin = pluginCtrl.setPlugin(PLUGIN_KEY, this);
        grid.registry.changes.subscribe((/**
         * @param {?} changes
         * @return {?}
         */
        changes => {
            for (const c of changes) {
                switch (c.type) {
                    case 'blocker':
                        this.setupBlocker();
                        break;
                }
            }
        }));
        pluginCtrl.events
            .subscribe((/**
         * @param {?} event
         * @return {?}
         */
        event => {
            if (event.kind === 'onDataSource') {
                const { prev, curr } = event;
                if (prev) {
                    UnRx.kill(this, prev);
                }
                curr.onSourceChanging
                    .pipe(UnRx(this, curr))
                    .subscribe((/**
                 * @return {?}
                 */
                () => {
                    if (this._blockUi === 'auto') {
                        this._blockInProgress = true;
                        this.setupBlocker();
                    }
                }));
                curr.onSourceChanged
                    .pipe(UnRx(this, curr))
                    .subscribe((/**
                 * @return {?}
                 */
                () => {
                    if (this._blockUi === 'auto') {
                        this._blockInProgress = false;
                        this.setupBlocker();
                    }
                }));
            }
        }));
    }
    /**
     * Blocks the UI with the template defined via `PblNgridBlockUiDefDirective`.
     * If a template does not exist blocking is ignored.
     *
     * There are 3 operation modes, the modes are set based on the input value:
     *   - Auto mode (INPUT: 'auto')
     *     The UI will be blocked automatically based on datasource changes.
     *
     *    - Manual mode (INPUT: boolean)
     *     The UI will be block is toggled based on the value, i.e. `true` will block and false will unblock.
     *
     *   - Notification mode (INPUT: Observable<boolean>)
     *     Similar to Manual mode but controlled by a stream boolean value.
     *
     * **Note about Notification mode**
     * Notification mode accepts an observable, at the point where the value is set the block state does not change (if it was "on" it will stay "on" and vice versa)
     * It will only change on the first emission, this is important to understand.
     *
     * For example, if the current block state is off and we pass a `Subject`, the state remains off until the next emission
     * of the `Subject` is `true`. If it already emitted `true` before the assignment it will not be taken into account. This is why
     * using `BehaviouralSubject` is preferred.
     *
     * Also note that when sending an observable it is treated as "notifier", do not send cold observable as they get subscribed to.
     * For example, sending the returned value from `HttpClient` will probably result in 2 HTTP calls, if you already subscribed to it
     * > The default value is `auto` which means that `<pbl-ngrid blockUi>` is similar to `<pbl-ngrid blockUi="auto">`
     * @return {?}
     */
    get blockUi() { return this._blockUi; }
    /**
     * @param {?} value
     * @return {?}
     */
    set blockUi(value) {
        /** @type {?} */
        let coerced = coerceBooleanProperty(value);
        if (coerced && (value === 'auto' || ((/** @type {?} */ (value))) === '')) {
            coerced = 'auto';
        }
        if (isObservable(value) && this._blockUi !== value) {
            if (isObservable(this._blockUi)) {
                UnRx.kill(this, this._blockUi);
            }
            this._blockUi = value;
            value.pipe(UnRx(this, this._blockUi)).subscribe((/**
             * @param {?} state
             * @return {?}
             */
            state => {
                this._blockInProgress = state;
                this.setupBlocker();
            }));
        }
        else if (this._blockUi !== coerced) {
            this._blockUi = coerced;
            if (coerced !== 'auto') {
                this._blockInProgress = coerced;
                this.setupBlocker();
            }
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this._removePlugin(this.grid);
    }
    /**
     * @private
     * @return {?}
     */
    setupBlocker() {
        /** @type {?} */
        const state = this._blockInProgress;
        if (state) {
            if (!this._blockerEmbeddedVRef) {
                /** @type {?} */
                const blockerTemplate = this.grid.registry.getSingle('blocker');
                if (blockerTemplate) {
                    this._blockerEmbeddedVRef = this.grid.createView('afterContent', blockerTemplate.tRef, { $implicit: this.grid });
                    this._blockerEmbeddedVRef.detectChanges();
                }
            }
        }
        else if (this._blockerEmbeddedVRef) {
            this.grid.removeView(this._blockerEmbeddedVRef, 'afterContent');
            this._blockerEmbeddedVRef = undefined;
        }
    }
};
PblNgridBlockUiPluginDirective.decorators = [
    { type: Directive, args: [{ selector: 'pbl-ngrid[blockUi]', exportAs: 'blockUi' },] }
];
/** @nocollapse */
PblNgridBlockUiPluginDirective.ctorParameters = () => [
    { type: PblNgridComponent },
    { type: PblNgridPluginController }
];
PblNgridBlockUiPluginDirective.propDecorators = {
    blockUi: [{ type: Input }]
};
/**
 * @template T
 */
PblNgridBlockUiPluginDirective = __decorate([
    NgridPlugin({ id: PLUGIN_KEY }),
    UnRx(),
    __metadata("design:paramtypes", [PblNgridComponent, PblNgridPluginController])
], PblNgridBlockUiPluginDirective);
export { PblNgridBlockUiPluginDirective };
if (false) {
    /**
     * @type {?}
     * @private
     */
    PblNgridBlockUiPluginDirective.prototype._blockInProgress;
    /**
     * @type {?}
     * @private
     */
    PblNgridBlockUiPluginDirective.prototype._blockUi;
    /**
     * @type {?}
     * @private
     */
    PblNgridBlockUiPluginDirective.prototype._blockerEmbeddedVRef;
    /**
     * @type {?}
     * @private
     */
    PblNgridBlockUiPluginDirective.prototype._removePlugin;
    /**
     * @type {?}
     * @private
     */
    PblNgridBlockUiPluginDirective.prototype.grid;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmxvY2stdWktcGx1Z2luLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHBlYnVsYS9uZ3JpZC9ibG9jay11aS8iLCJzb3VyY2VzIjpbImxpYi9ibG9jay11aS9ibG9jay11aS1wbHVnaW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFjLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNoRCxPQUFPLEVBQUUsU0FBUyxFQUFtQixLQUFLLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDN0UsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFOUQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsd0JBQXdCLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDOztNQVFuRixVQUFVLEdBQWMsU0FBUzs7OztJQUsxQiw4QkFBOEI7OztNQUE5Qiw4QkFBOEI7Ozs7O0lBMER6QyxZQUFvQixJQUE0QixFQUFFLFVBQXVDO1FBQXJFLFNBQUksR0FBSixJQUFJLENBQXdCO1FBTHhDLHFCQUFnQixHQUFZLEtBQUssQ0FBQztRQU14QyxJQUFJLENBQUMsYUFBYSxHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTVELElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFNBQVM7Ozs7UUFBRSxPQUFPLENBQUMsRUFBRTtZQUN6QyxLQUFLLE1BQU0sQ0FBQyxJQUFJLE9BQU8sRUFBRTtnQkFDdkIsUUFBUSxDQUFDLENBQUMsSUFBSSxFQUFFO29CQUNkLEtBQUssU0FBUzt3QkFDWixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7d0JBQ3BCLE1BQU07aUJBQ1Q7YUFDRjtRQUNILENBQUMsRUFBQyxDQUFDO1FBRUgsVUFBVSxDQUFDLE1BQU07YUFDZCxTQUFTOzs7O1FBQUUsS0FBSyxDQUFDLEVBQUU7WUFDbEIsSUFB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QVMsQ0FBQyxTQUFTLENBQUM7Z0JBQy9ELElBQUksZUFBZSxFQUFFO29CQUNuQixJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYyxFQUFFLGVBQWUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7b0JBQ2pILElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxhQUFhLEVBQUUsQ0FBQztpQkFDM0M7YUFDRjtTQUNGO2FBQU0sSUFBSSxJQUFJLENBQUMsb0JBQW9CLEVBQUU7WUFDcEMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLG9CQUFvQixFQUFFLGNBQWMsQ0FBQyxDQUFDO1lBQ2hFLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxTQUFTLENBQUM7U0FDdkM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTs7WUF4SEEsU0FBUyxTQUFDLEVBQUUsUUFBUSxFQUFFLG9CQUFvQixFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUU7Ozs7WUFYekQsaUJBQWlCO1lBQUUsd0JBQXdCOzs7c0JBeUNqRCxLQUFLOzs7OztBQTVCSyw4QkFBOEI7SUFIMUMsV0FBVyxDQUFDLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxDQUFDO0lBRS9CLElBQUksRUFBRTtxQ0EyRHFCLGlCQUFpQixFQUFtQix3QkFBd0I7R0ExRDNFLDhCQUE4QixDQXNIMUM7U0F0SFksOEJBQThCOzs7Ozs7SUFxRHpDLDBEQUEwQzs7Ozs7SUFDMUMsa0RBQXlEOzs7OztJQUN6RCw4REFBbUQ7Ozs7O0lBQ25ELHVEQUE4RDs7Ozs7SUFFbEQsOENBQW9DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgaXNPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBEaXJlY3RpdmUsIEVtYmVkZGVkVmlld1JlZiwgSW5wdXQsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgY29lcmNlQm9vbGVhblByb3BlcnR5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2NvZXJjaW9uJztcblxuaW1wb3J0IHsgVW5SeCB9IGZyb20gJ0BwZWJ1bGEvdXRpbHMnO1xuaW1wb3J0IHsgUGJsTmdyaWRDb21wb25lbnQsIFBibE5ncmlkUGx1Z2luQ29udHJvbGxlciwgTmdyaWRQbHVnaW4gfSBmcm9tICdAcGVidWxhL25ncmlkJztcblxuZGVjbGFyZSBtb2R1bGUgJ0BwZWJ1bGEvbmdyaWQvbGliL2V4dC90eXBlcycge1xuICBpbnRlcmZhY2UgUGJsTmdyaWRQbHVnaW5FeHRlbnNpb24ge1xuICAgIGJsb2NrVWk/OiB7IGJsb2NrVWk6IGJvb2xlYW4gfCAnYXV0bycgfCBPYnNlcnZhYmxlPGJvb2xlYW4+IH07XG4gIH1cbn1cblxuY29uc3QgUExVR0lOX0tFWTogJ2Jsb2NrVWknID0gJ2Jsb2NrVWknO1xuXG5ATmdyaWRQbHVnaW4oeyBpZDogUExVR0lOX0tFWSB9KVxuQERpcmVjdGl2ZSh7IHNlbGVjdG9yOiAncGJsLW5ncmlkW2Jsb2NrVWldJywgZXhwb3J0QXM6ICdibG9ja1VpJyB9KVxuQFVuUngoKVxuZXhwb3J0IGNsYXNzIFBibE5ncmlkQmxvY2tVaVBsdWdpbkRpcmVjdGl2ZTxUPiBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG5cbiAgLyoqXG4gICAqIEJsb2NrcyB0aGUgVUkgd2l0aCB0aGUgdGVtcGxhdGUgZGVmaW5lZCB2aWEgYFBibE5ncmlkQmxvY2tVaURlZkRpcmVjdGl2ZWAuXG4gICAqIElmIGEgdGVtcGxhdGUgZG9lcyBub3QgZXhpc3QgYmxvY2tpbmcgaXMgaWdub3JlZC5cbiAgICpcbiAgICogVGhlcmUgYXJlIDMgb3BlcmF0aW9uIG1vZGVzLCB0aGUgbW9kZXMgYXJlIHNldCBiYXNlZCBvbiB0aGUgaW5wdXQgdmFsdWU6XG4gICAqICAgLSBBdXRvIG1vZGUgKElOUFVUOiAnYXV0bycpXG4gICAqICAgICBUaGUgVUkgd2lsbCBiZSBibG9ja2VkIGF1dG9tYXRpY2FsbHkgYmFzZWQgb24gZGF0YXNvdXJjZSBjaGFuZ2VzLlxuICAgKlxuICAgKiAgICAtIE1hbnVhbCBtb2RlIChJTlBVVDogYm9vbGVhbilcbiAgICogICAgIFRoZSBVSSB3aWxsIGJlIGJsb2NrIGlzIHRvZ2dsZWQgYmFzZWQgb24gdGhlIHZhbHVlLCBpLmUuIGB0cnVlYCB3aWxsIGJsb2NrIGFuZCBmYWxzZSB3aWxsIHVuYmxvY2suXG4gICAqXG4gICAqICAgLSBOb3RpZmljYXRpb24gbW9kZSAoSU5QVVQ6IE9ic2VydmFibGU8Ym9vbGVhbj4pXG4gICAqICAgICBTaW1pbGFyIHRvIE1hbnVhbCBtb2RlIGJ1dCBjb250cm9sbGVkIGJ5IGEgc3RyZWFtIGJvb2xlYW4gdmFsdWUuXG4gICAqXG4gICAqICoqTm90ZSBhYm91dCBOb3RpZmljYXRpb24gbW9kZSoqXG4gICAqIE5vdGlmaWNhdGlvbiBtb2RlIGFjY2VwdHMgYW4gb2JzZXJ2YWJsZSwgYXQgdGhlIHBvaW50IHdoZXJlIHRoZSB2YWx1ZSBpcyBzZXQgdGhlIGJsb2NrIHN0YXRlIGRvZXMgbm90IGNoYW5nZSAoaWYgaXQgd2FzIFwib25cIiBpdCB3aWxsIHN0YXkgXCJvblwiIGFuZCB2aWNlIHZlcnNhKVxuICAgKiBJdCB3aWxsIG9ubHkgY2hhbmdlIG9uIHRoZSBmaXJzdCBlbWlzc2lvbiwgdGhpcyBpcyBpbXBvcnRhbnQgdG8gdW5kZXJzdGFuZC5cbiAgICpcbiAgICogRm9yIGV4YW1wbGUsIGlmIHRoZSBjdXJyZW50IGJsb2NrIHN0YXRlIGlzIG9mZiBhbmQgd2UgcGFzcyBhIGBTdWJqZWN0YCwgdGhlIHN0YXRlIHJlbWFpbnMgb2ZmIHVudGlsIHRoZSBuZXh0IGVtaXNzaW9uXG4gICAqIG9mIHRoZSBgU3ViamVjdGAgaXMgYHRydWVgLiBJZiBpdCBhbHJlYWR5IGVtaXR0ZWQgYHRydWVgIGJlZm9yZSB0aGUgYXNzaWdubWVudCBpdCB3aWxsIG5vdCBiZSB0YWtlbiBpbnRvIGFjY291bnQuIFRoaXMgaXMgd2h5XG4gICAqIHVzaW5nIGBCZWhhdmlvdXJhbFN1YmplY3RgIGlzIHByZWZlcnJlZC5cbiAgICpcbiAgICogQWxzbyBub3RlIHRoYXQgd2hlbiBzZW5kaW5nIGFuIG9ic2VydmFibGUgaXQgaXMgdHJlYXRlZCBhcyBcIm5vdGlmaWVyXCIsIGRvIG5vdCBzZW5kIGNvbGQgb2JzZXJ2YWJsZSBhcyB0aGV5IGdldCBzdWJzY3JpYmVkIHRvLlxuICAgKiBGb3IgZXhhbXBsZSwgc2VuZGluZyB0aGUgcmV0dXJuZWQgdmFsdWUgZnJvbSBgSHR0cENsaWVudGAgd2lsbCBwcm9iYWJseSByZXN1bHQgaW4gMiBIVFRQIGNhbGxzLCBpZiB5b3UgYWxyZWFkeSBzdWJzY3JpYmVkIHRvIGl0XG4gICAqID4gVGhlIGRlZmF1bHQgdmFsdWUgaXMgYGF1dG9gIHdoaWNoIG1lYW5zIHRoYXQgYDxwYmwtbmdyaWQgYmxvY2tVaT5gIGlzIHNpbWlsYXIgdG8gYDxwYmwtbmdyaWQgYmxvY2tVaT1cImF1dG9cIj5gXG4gICAqL1xuICBASW5wdXQoKSBnZXQgYmxvY2tVaSgpOiBib29sZWFuIHwgJ2F1dG8nIHwgT2JzZXJ2YWJsZTxib29sZWFuPiB7IHJldHVybiB0aGlzLl9ibG9ja1VpOyB9XG4gIHNldCBibG9ja1VpKHZhbHVlOiBib29sZWFuIHwgJ2F1dG8nIHwgT2JzZXJ2YWJsZTxib29sZWFuPikge1xuICAgIGxldCBjb2VyY2VkOiBib29sZWFuIHwgJ2F1dG8nID0gY29lcmNlQm9vbGVhblByb3BlcnR5KHZhbHVlKTtcbiAgICBpZiAoY29lcmNlZCAmJiAodmFsdWUgPT09ICdhdXRvJyB8fCAodmFsdWUgYXMgYW55KSA9PT0gJycpKSB7XG4gICAgICBjb2VyY2VkID0gJ2F1dG8nO1xuICAgIH1cblxuICAgIGlmIChpc09ic2VydmFibGUodmFsdWUpICYmIHRoaXMuX2Jsb2NrVWkgIT09IHZhbHVlKSB7XG4gICAgICBpZiAoaXNPYnNlcnZhYmxlKHRoaXMuX2Jsb2NrVWkpKSB7XG4gICAgICAgIFVuUngua2lsbCh0aGlzLCB0aGlzLl9ibG9ja1VpKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX2Jsb2NrVWkgPSB2YWx1ZTtcbiAgICAgIHZhbHVlLnBpcGUoVW5SeCh0aGlzLCB0aGlzLl9ibG9ja1VpKSkuc3Vic2NyaWJlKCBzdGF0ZSA9PiB7XG4gICAgICAgIHRoaXMuX2Jsb2NrSW5Qcm9ncmVzcyA9IHN0YXRlO1xuICAgICAgICB0aGlzLnNldHVwQmxvY2tlcigpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLl9ibG9ja1VpICE9PSBjb2VyY2VkKSB7XG4gICAgICB0aGlzLl9ibG9ja1VpID0gY29lcmNlZDtcbiAgICAgIGlmIChjb2VyY2VkICE9PSAnYXV0bycpIHtcbiAgICAgICAgdGhpcy5fYmxvY2tJblByb2dyZXNzID0gY29lcmNlZDtcbiAgICAgICAgdGhpcy5zZXR1cEJsb2NrZXIoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9ibG9ja0luUHJvZ3Jlc3M6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBfYmxvY2tVaTogYm9vbGVhbiB8ICdhdXRvJyB8IE9ic2VydmFibGU8Ym9vbGVhbj47XG4gIHByaXZhdGUgX2Jsb2NrZXJFbWJlZGRlZFZSZWY6IEVtYmVkZGVkVmlld1JlZjxhbnk+O1xuICBwcml2YXRlIF9yZW1vdmVQbHVnaW46IChncmlkOiBQYmxOZ3JpZENvbXBvbmVudDxhbnk+KSA9PiB2b2lkO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZ3JpZDogUGJsTmdyaWRDb21wb25lbnQ8YW55PiwgcGx1Z2luQ3RybDogUGJsTmdyaWRQbHVnaW5Db250cm9sbGVyPFQ+KSB7XG4gICAgdGhpcy5fcmVtb3ZlUGx1Z2luID0gcGx1Z2luQ3RybC5zZXRQbHVnaW4oUExVR0lOX0tFWSwgdGhpcyk7XG5cbiAgICBncmlkLnJlZ2lzdHJ5LmNoYW5nZXMuc3Vic2NyaWJlKCBjaGFuZ2VzID0+IHtcbiAgICAgIGZvciAoY29uc3QgYyBvZiBjaGFuZ2VzKSB7XG4gICAgICAgIHN3aXRjaCAoYy50eXBlKSB7XG4gICAgICAgICAgY2FzZSAnYmxvY2tlcic6XG4gICAgICAgICAgICB0aGlzLnNldHVwQmxvY2tlcigpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHBsdWdpbkN0cmwuZXZlbnRzXG4gICAgICAuc3Vic2NyaWJlKCBldmVudCA9PiB7XG4gICAgICAgIGlmIChldmVudC5raW5kID09PSAnb25EYXRhU291cmNlJykge1xuICAgICAgICAgIGNvbnN0IHsgcHJldiwgY3VyciB9ID0gZXZlbnQ7XG4gICAgICAgICAgaWYgKHByZXYpIHtcbiAgICAgICAgICAgIFVuUngua2lsbCh0aGlzLCBwcmV2KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY3Vyci5vblNvdXJjZUNoYW5naW5nXG4gICAgICAgICAgICAucGlwZShVblJ4KHRoaXMsIGN1cnIpKVxuICAgICAgICAgICAgLnN1YnNjcmliZSggKCkgPT4ge1xuICAgICAgICAgICAgICBpZiAodGhpcy5fYmxvY2tVaSA9PT0gJ2F1dG8nKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fYmxvY2tJblByb2dyZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0aGlzLnNldHVwQmxvY2tlcigpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICBjdXJyLm9uU291cmNlQ2hhbmdlZFxuICAgICAgICAgICAgLnBpcGUoVW5SeCh0aGlzLCBjdXJyKSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoICgpID0+IHtcbiAgICAgICAgICAgICAgaWYgKHRoaXMuX2Jsb2NrVWkgPT09ICdhdXRvJykge1xuICAgICAgICAgICAgICAgIHRoaXMuX2Jsb2NrSW5Qcm9ncmVzcyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0dXBCbG9ja2VyKCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5fcmVtb3ZlUGx1Z2luKHRoaXMuZ3JpZCk7XG4gIH1cblxuICBwcml2YXRlIHNldHVwQmxvY2tlcigpOiB2b2lkIHtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuX2Jsb2NrSW5Qcm9ncmVzcztcbiAgICBpZiAoc3RhdGUpIHtcbiAgICAgIGlmICghdGhpcy5fYmxvY2tlckVtYmVkZGVkVlJlZikge1xuICAgICAgICBjb25zdCBibG9ja2VyVGVtcGxhdGUgPSB0aGlzLmdyaWQucmVnaXN0cnkuZ2V0U2luZ2xlKCdibG9ja2VyJyk7XG4gICAgICAgIGlmIChibG9ja2VyVGVtcGxhdGUpIHtcbiAgICAgICAgICB0aGlzLl9ibG9ja2VyRW1iZWRkZWRWUmVmID0gdGhpcy5ncmlkLmNyZWF0ZVZpZXcoJ2FmdGVyQ29udGVudCcsIGJsb2NrZXJUZW1wbGF0ZS50UmVmLCB7ICRpbXBsaWNpdDogdGhpcy5ncmlkIH0pO1xuICAgICAgICAgIHRoaXMuX2Jsb2NrZXJFbWJlZGRlZFZSZWYuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIGlmICh0aGlzLl9ibG9ja2VyRW1iZWRkZWRWUmVmKSB7XG4gICAgICB0aGlzLmdyaWQucmVtb3ZlVmlldyh0aGlzLl9ibG9ja2VyRW1iZWRkZWRWUmVmLCAnYWZ0ZXJDb250ZW50Jyk7XG4gICAgICB0aGlzLl9ibG9ja2VyRW1iZWRkZWRWUmVmID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxufVxuIl19