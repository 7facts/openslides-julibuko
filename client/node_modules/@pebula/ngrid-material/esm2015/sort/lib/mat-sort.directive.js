/**
 * @fileoverview added by tsickle
 * Generated from: lib/mat-sort.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { __decorate, __metadata } from "tslib";
import { Directive } from '@angular/core';
import { MatSort } from '@angular/material/sort';
import { UnRx } from '@pebula/utils';
import { PblNgridComponent, PblNgridPluginController, NgridPlugin } from '@pebula/ngrid';
/** @type {?} */
const PLUGIN_KEY = 'matSort';
let PblNgridMatSortDirective = class PblNgridMatSortDirective {
    /**
     * @param {?} table
     * @param {?} pluginCtrl
     * @param {?} sort
     */
    constructor(table, pluginCtrl, sort) {
        this.table = table;
        this.pluginCtrl = pluginCtrl;
        this.sort = sort;
        this._removePlugin = pluginCtrl.setPlugin(PLUGIN_KEY, this);
        /** @type {?} */
        let origin = 'click';
        this.sort.sortChange
            .pipe(UnRx(this))
            .subscribe((/**
         * @param {?} s
         * @return {?}
         */
        s => {
            this.onSort(s, origin);
            origin = 'click';
        }));
        /** @type {?} */
        const handleDataSourceSortChange = (/**
         * @param {?} sortChange
         * @return {?}
         */
        (sortChange) => {
            const { column } = sortChange;
            /** @type {?} */
            const order = sortChange.sort ? sortChange.sort.order : undefined;
            if (this.sort && column) {
                if (this.sort.active === column.id && this.sort.direction === (order || '')) {
                    return;
                }
                /** @type {?} */
                const sortable = (/** @type {?} */ (this.sort.sortables.get(column.id)));
                if (sortable) {
                    origin = 'ds';
                    this.sort.active = undefined;
                    sortable.start = order || 'asc';
                    sortable._handleClick();
                }
            }
            else if (this.sort.active) { // clear mode (hit from code, not click).
                // clear mode (hit from code, not click).
                /** @type {?} */
                const sortable = (/** @type {?} */ (this.sort.sortables.get(this.sort.active)));
                if (sortable) {
                    if (!sortable.disableClear) {
                        /** @type {?} */
                        let nextSortDir;
                        while (nextSortDir = this.sort.getNextSortDirection(sortable)) {
                            this.sort.direction = nextSortDir;
                        }
                    }
                    origin = 'ds';
                    sortable._handleClick();
                }
            }
        });
        pluginCtrl.events
            .subscribe((/**
         * @param {?} e
         * @return {?}
         */
        e => {
            if (e.kind === 'onInvalidateHeaders') {
                /** @type {?} */
                const hasActiveSort = this.sort && this.sort.active;
                if (table.ds && table.ds.sort) {
                    if (!table.ds.sort.column && hasActiveSort) {
                        this.onSort({ active: this.sort.active, direction: this.sort.direction || 'asc' }, origin);
                    }
                    else if (table.ds.sort.column && !hasActiveSort) {
                        setTimeout((/**
                         * @return {?}
                         */
                        () => handleDataSourceSortChange(table.ds.sort)));
                    }
                }
            }
            if (e.kind === 'onDataSource') {
                UnRx.kill(this, e.prev);
                if (this.sort && this.sort.active) {
                    this.onSort({ active: this.sort.active, direction: this.sort.direction || 'asc' }, origin);
                }
                table.ds.sortChange
                    .pipe(UnRx(this, e.curr))
                    .subscribe((/**
                 * @param {?} event
                 * @return {?}
                 */
                event => { handleDataSourceSortChange(event); }));
            }
        }));
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this._removePlugin(this.table);
    }
    /**
     * @private
     * @param {?} sort
     * @param {?} origin
     * @return {?}
     */
    onSort(sort, origin) {
        /** @type {?} */
        const table = this.table;
        /** @type {?} */
        const column = table.columnApi.visibleColumns.find((/**
         * @param {?} c
         * @return {?}
         */
        c => c.id === sort.active));
        if (origin !== 'click' || !column || !column.sort) {
            return;
        }
        else {
            /** @type {?} */
            const newSort = {};
            /** @type {?} */
            const sortFn = typeof column.sort === 'function' && column.sort;
            if (sort.direction) {
                newSort.order = sort.direction;
            }
            if (sortFn) {
                newSort.sortFn = sortFn;
            }
            /** @type {?} */
            const currentSort = table.ds.sort;
            if (column === currentSort.column) {
                /** @type {?} */
                const _sort = currentSort.sort || {};
                if (newSort.order === _sort.order) {
                    return;
                }
            }
            table.ds.setSort(column, newSort);
        }
    }
};
PblNgridMatSortDirective.decorators = [
    { type: Directive, args: [{ selector: 'pbl-ngrid[matSort]', exportAs: 'pblMatSort' },] }
];
/** @nocollapse */
PblNgridMatSortDirective.ctorParameters = () => [
    { type: PblNgridComponent },
    { type: PblNgridPluginController },
    { type: MatSort }
];
PblNgridMatSortDirective = __decorate([
    NgridPlugin({ id: PLUGIN_KEY }),
    UnRx(),
    __metadata("design:paramtypes", [PblNgridComponent, PblNgridPluginController, MatSort])
], PblNgridMatSortDirective);
export { PblNgridMatSortDirective };
if (false) {
    /**
     * @type {?}
     * @private
     */
    PblNgridMatSortDirective.prototype._removePlugin;
    /** @type {?} */
    PblNgridMatSortDirective.prototype.table;
    /**
     * @type {?}
     * @private
     */
    PblNgridMatSortDirective.prototype.pluginCtrl;
    /** @type {?} */
    PblNgridMatSortDirective.prototype.sort;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0LXNvcnQuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHBlYnVsYS9uZ3JpZC1tYXRlcmlhbC9zb3J0LyIsInNvdXJjZXMiOlsibGliL21hdC1zb3J0LmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBUSxPQUFPLEVBQWdDLE1BQU0sd0JBQXdCLENBQUM7QUFFckYsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsd0JBQXdCLEVBQUUsV0FBVyxFQUF5QyxNQUFNLGVBQWUsQ0FBQzs7TUFPMUgsVUFBVSxHQUFjLFNBQVM7SUFLMUIsd0JBQXdCLFNBQXhCLHdCQUF3Qjs7Ozs7O0lBR25DLFlBQW1CLEtBQTZCLEVBQVUsVUFBb0MsRUFBUyxJQUFhO1FBQWpHLFVBQUssR0FBTCxLQUFLLENBQXdCO1FBQVUsZUFBVSxHQUFWLFVBQVUsQ0FBMEI7UUFBUyxTQUFJLEdBQUosSUFBSSxDQUFTO1FBQ2xILElBQUksQ0FBQyxhQUFhLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7O1lBRXhELE1BQU0sR0FBbUIsT0FBTztRQUNwQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVU7YUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNoQixTQUFTOzs7O1FBQUUsQ0FBQyxDQUFDLEVBQUU7WUFDZCxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUN2QixNQUFNLEdBQUcsT0FBTyxDQUFDO1FBQ25CLENBQUMsRUFBQyxDQUFDOztjQUVDLDBCQUEwQjs7OztRQUFHLENBQUMsVUFBaUMsRUFBRSxFQUFFO2tCQUNqRSxFQUFFLE1BQU0sRUFBRSxHQUFHLFVBQVU7O2tCQUN2QixLQUFLLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVM7WUFFakUsSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLE1BQU0sRUFBRTtnQkFDdkIsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsRUFBRSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxLQUFLLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxFQUFFO29CQUFFLE9BQU87aUJBQUU7O3NCQUNsRixRQUFRLEdBQWtCLG1CQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQU87Z0JBQ3pFLElBQUksUUFBUSxFQUFFO29CQUNaLE1BQU0sR0FBRyxJQUFJLENBQUM7b0JBQ2QsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDO29CQUM3QixRQUFRLENBQUMsS0FBSyxHQUFHLEtBQUssSUFBSSxLQUFLLENBQUM7b0JBQ2hDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztpQkFDekI7YUFDRjtpQkFBTSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEVBQUUseUNBQXlDOzs7c0JBQ2hFLFFBQVEsR0FBa0IsbUJBQUEsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQU87Z0JBQ2hGLElBQUksUUFBUSxFQUFHO29CQUNiLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxFQUFFOzs0QkFDdEIsV0FBMEI7d0JBQzlCLE9BQU8sV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxDQUFDLEVBQUU7NEJBQzdELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLFdBQVcsQ0FBQzt5QkFDbkM7cUJBQ0Y7b0JBQ0QsTUFBTSxHQUFHLElBQUksQ0FBQztvQkFDZCxRQUFRLENBQUMsWUFBWSxFQUFFLENBQUM7aUJBQ3pCO2FBQ0Y7UUFDSCxDQUFDLENBQUE7UUFFRCxVQUFVLENBQUMsTUFBTTthQUNkLFNBQVM7Ozs7UUFBRSxDQUFDLENBQUMsRUFBRTtZQUNkLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxxQkFBcUIsRUFBRTs7c0JBQzlCLGFBQWEsR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTTtnQkFDbkQsSUFBSSxLQUFLLENBQUMsRUFBRSxJQUFJLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxFQUFFO29CQUM3QixJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLGFBQWEsRUFBRTt3QkFDMUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksS0FBSyxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUM7cUJBQzVGO3lCQUFNLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsYUFBYSxFQUFFO3dCQUNqRCxVQUFVOzs7d0JBQUMsR0FBRyxFQUFFLENBQUMsMEJBQTBCLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBQyxDQUFDO3FCQUM3RDtpQkFDRjthQUNGO1lBQ0QsSUFBSSxDQUFDLENBQUMsSUFBSSxLQUFLLGNBQWMsRUFBRTtnQkFDN0IsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUN4QixJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7b0JBQ2pDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLEtBQUssRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDO2lCQUM1RjtnQkFDRCxLQUFLLENBQUMsRUFBRSxDQUFDLFVBQVU7cUJBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztxQkFDeEIsU0FBUzs7OztnQkFBRSxLQUFLLENBQUMsRUFBRSxHQUFHLDBCQUEwQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFDLENBQUM7YUFDaEU7UUFDSCxDQUFDLEVBQUMsQ0FBQztJQUNQLENBQUM7Ozs7SUFFRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDakMsQ0FBQzs7Ozs7OztJQUVPLE1BQU0sQ0FBQyxJQUFVLEVBQUUsTUFBc0I7O2NBQ3pDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSzs7Y0FDbEIsTUFBTSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLElBQUk7Ozs7UUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLE1BQU0sRUFBQztRQUU3RSxJQUFLLE1BQU0sS0FBSyxPQUFPLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFHO1lBQ25ELE9BQU87U0FDUjthQUFNOztrQkFDQyxPQUFPLEdBQTJCLEVBQUc7O2tCQUNyQyxNQUFNLEdBQUcsT0FBTyxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsSUFBSSxNQUFNLENBQUMsSUFBSTtZQUMvRCxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7Z0JBQ2xCLE9BQU8sQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQzthQUNoQztZQUNELElBQUksTUFBTSxFQUFFO2dCQUNWLE9BQU8sQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO2FBQ3pCOztrQkFDSyxXQUFXLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJO1lBQ2pDLElBQUksTUFBTSxLQUFLLFdBQVcsQ0FBQyxNQUFNLEVBQUU7O3NCQUMzQixLQUFLLEdBQUcsV0FBVyxDQUFDLElBQUksSUFBSSxFQUFFO2dCQUNwQyxJQUFJLE9BQU8sQ0FBQyxLQUFLLEtBQUssS0FBSyxDQUFDLEtBQUssRUFBRTtvQkFDakMsT0FBTztpQkFDUjthQUNGO1lBQ0QsS0FBSyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ25DO0lBQ0gsQ0FBQztDQUVGLENBQUE7O1lBbEdBLFNBQVMsU0FBQyxFQUFFLFFBQVEsRUFBRSxvQkFBb0IsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFOzs7O1lBVjVELGlCQUFpQjtZQUFFLHdCQUF3QjtZQUhyQyxPQUFPOztBQWVULHdCQUF3QjtJQUhwQyxXQUFXLENBQUMsRUFBRSxFQUFFLEVBQUUsVUFBVSxFQUFFLENBQUM7SUFFL0IsSUFBSSxFQUFFO3FDQUlxQixpQkFBaUIsRUFBMkIsd0JBQXdCLEVBQWUsT0FBTztHQUh6Ryx3QkFBd0IsQ0FnR3BDO1NBaEdZLHdCQUF3Qjs7Ozs7O0lBQ25DLGlEQUErRDs7SUFFbkQseUNBQW9DOzs7OztJQUFFLDhDQUE0Qzs7SUFBRSx3Q0FBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU29ydCwgTWF0U29ydCwgTWF0U29ydEhlYWRlciwgU29ydERpcmVjdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL3NvcnQnO1xuXG5pbXBvcnQgeyBVblJ4IH0gZnJvbSAnQHBlYnVsYS91dGlscyc7XG5pbXBvcnQgeyBQYmxOZ3JpZENvbXBvbmVudCwgUGJsTmdyaWRQbHVnaW5Db250cm9sbGVyLCBOZ3JpZFBsdWdpbiwgUGJsTmdyaWRTb3J0RGVmaW5pdGlvbiwgUGJsRGF0YVNvdXJjZSB9IGZyb20gJ0BwZWJ1bGEvbmdyaWQnO1xuXG5kZWNsYXJlIG1vZHVsZSAnQHBlYnVsYS9uZ3JpZC9saWIvZXh0L3R5cGVzJyB7XG4gIGludGVyZmFjZSBQYmxOZ3JpZFBsdWdpbkV4dGVuc2lvbiB7XG4gICAgbWF0U29ydD86IFBibE5ncmlkTWF0U29ydERpcmVjdGl2ZTtcbiAgfVxufVxuY29uc3QgUExVR0lOX0tFWTogJ21hdFNvcnQnID0gJ21hdFNvcnQnO1xuXG5ATmdyaWRQbHVnaW4oeyBpZDogUExVR0lOX0tFWSB9KVxuQERpcmVjdGl2ZSh7IHNlbGVjdG9yOiAncGJsLW5ncmlkW21hdFNvcnRdJywgZXhwb3J0QXM6ICdwYmxNYXRTb3J0JyB9KVxuQFVuUngoKVxuZXhwb3J0IGNsYXNzIFBibE5ncmlkTWF0U29ydERpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgX3JlbW92ZVBsdWdpbjogKHRhYmxlOiBQYmxOZ3JpZENvbXBvbmVudDxhbnk+KSA9PiB2b2lkO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyB0YWJsZTogUGJsTmdyaWRDb21wb25lbnQ8YW55PiwgcHJpdmF0ZSBwbHVnaW5DdHJsOiBQYmxOZ3JpZFBsdWdpbkNvbnRyb2xsZXIsIHB1YmxpYyBzb3J0OiBNYXRTb3J0KSB7XG4gICAgdGhpcy5fcmVtb3ZlUGx1Z2luID0gcGx1Z2luQ3RybC5zZXRQbHVnaW4oUExVR0lOX0tFWSwgdGhpcyk7XG5cbiAgICBsZXQgb3JpZ2luOiAnZHMnIHwgJ2NsaWNrJyA9ICdjbGljayc7XG4gICAgdGhpcy5zb3J0LnNvcnRDaGFuZ2VcbiAgICAgIC5waXBlKFVuUngodGhpcykpXG4gICAgICAuc3Vic2NyaWJlKCBzID0+IHtcbiAgICAgICAgdGhpcy5vblNvcnQocywgb3JpZ2luKTtcbiAgICAgICAgb3JpZ2luID0gJ2NsaWNrJztcbiAgICAgIH0pO1xuXG4gICAgY29uc3QgaGFuZGxlRGF0YVNvdXJjZVNvcnRDaGFuZ2UgPSAoc29ydENoYW5nZTogUGJsRGF0YVNvdXJjZVsnc29ydCddKSA9PiB7XG4gICAgICBjb25zdCB7IGNvbHVtbiB9ID0gc29ydENoYW5nZTtcbiAgICAgIGNvbnN0IG9yZGVyID0gc29ydENoYW5nZS5zb3J0ID8gc29ydENoYW5nZS5zb3J0Lm9yZGVyIDogdW5kZWZpbmVkO1xuXG4gICAgICBpZiAodGhpcy5zb3J0ICYmIGNvbHVtbikge1xuICAgICAgICBpZiAodGhpcy5zb3J0LmFjdGl2ZSA9PT0gY29sdW1uLmlkICYmIHRoaXMuc29ydC5kaXJlY3Rpb24gPT09IChvcmRlciB8fCAnJykpIHsgcmV0dXJuOyB9XG4gICAgICAgIGNvbnN0IHNvcnRhYmxlOiBNYXRTb3J0SGVhZGVyID0gdGhpcy5zb3J0LnNvcnRhYmxlcy5nZXQoY29sdW1uLmlkKSBhcyBhbnk7XG4gICAgICAgIGlmIChzb3J0YWJsZSkge1xuICAgICAgICAgIG9yaWdpbiA9ICdkcyc7XG4gICAgICAgICAgdGhpcy5zb3J0LmFjdGl2ZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICBzb3J0YWJsZS5zdGFydCA9IG9yZGVyIHx8ICdhc2MnO1xuICAgICAgICAgIHNvcnRhYmxlLl9oYW5kbGVDbGljaygpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuc29ydC5hY3RpdmUpIHsgLy8gY2xlYXIgbW9kZSAoaGl0IGZyb20gY29kZSwgbm90IGNsaWNrKS5cbiAgICAgICAgY29uc3Qgc29ydGFibGU6IE1hdFNvcnRIZWFkZXIgPSB0aGlzLnNvcnQuc29ydGFibGVzLmdldCh0aGlzLnNvcnQuYWN0aXZlKSBhcyBhbnk7XG4gICAgICAgIGlmIChzb3J0YWJsZSApIHtcbiAgICAgICAgICBpZiAoIXNvcnRhYmxlLmRpc2FibGVDbGVhcikge1xuICAgICAgICAgICAgbGV0IG5leHRTb3J0RGlyOiBTb3J0RGlyZWN0aW9uO1xuICAgICAgICAgICAgd2hpbGUgKG5leHRTb3J0RGlyID0gdGhpcy5zb3J0LmdldE5leHRTb3J0RGlyZWN0aW9uKHNvcnRhYmxlKSkge1xuICAgICAgICAgICAgICB0aGlzLnNvcnQuZGlyZWN0aW9uID0gbmV4dFNvcnREaXI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIG9yaWdpbiA9ICdkcyc7XG4gICAgICAgICAgc29ydGFibGUuX2hhbmRsZUNsaWNrKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBwbHVnaW5DdHJsLmV2ZW50c1xuICAgICAgLnN1YnNjcmliZSggZSA9PiB7XG4gICAgICAgIGlmIChlLmtpbmQgPT09ICdvbkludmFsaWRhdGVIZWFkZXJzJykge1xuICAgICAgICAgIGNvbnN0IGhhc0FjdGl2ZVNvcnQgPSB0aGlzLnNvcnQgJiYgdGhpcy5zb3J0LmFjdGl2ZTtcbiAgICAgICAgICBpZiAodGFibGUuZHMgJiYgdGFibGUuZHMuc29ydCkge1xuICAgICAgICAgICAgaWYgKCF0YWJsZS5kcy5zb3J0LmNvbHVtbiAmJiBoYXNBY3RpdmVTb3J0KSB7XG4gICAgICAgICAgICAgIHRoaXMub25Tb3J0KHsgYWN0aXZlOiB0aGlzLnNvcnQuYWN0aXZlLCBkaXJlY3Rpb246IHRoaXMuc29ydC5kaXJlY3Rpb24gfHwgJ2FzYycgfSwgb3JpZ2luKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGFibGUuZHMuc29ydC5jb2x1bW4gJiYgIWhhc0FjdGl2ZVNvcnQpIHtcbiAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBoYW5kbGVEYXRhU291cmNlU29ydENoYW5nZSh0YWJsZS5kcy5zb3J0KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChlLmtpbmQgPT09ICdvbkRhdGFTb3VyY2UnKSB7XG4gICAgICAgICAgVW5SeC5raWxsKHRoaXMsIGUucHJldik7XG4gICAgICAgICAgaWYgKHRoaXMuc29ydCAmJiB0aGlzLnNvcnQuYWN0aXZlKSB7XG4gICAgICAgICAgICB0aGlzLm9uU29ydCh7IGFjdGl2ZTogdGhpcy5zb3J0LmFjdGl2ZSwgZGlyZWN0aW9uOiB0aGlzLnNvcnQuZGlyZWN0aW9uIHx8ICdhc2MnIH0sIG9yaWdpbik7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRhYmxlLmRzLnNvcnRDaGFuZ2VcbiAgICAgICAgICAgIC5waXBlKFVuUngodGhpcywgZS5jdXJyKSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoIGV2ZW50ID0+IHsgaGFuZGxlRGF0YVNvdXJjZVNvcnRDaGFuZ2UoZXZlbnQpOyB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLl9yZW1vdmVQbHVnaW4odGhpcy50YWJsZSk7XG4gIH1cblxuICBwcml2YXRlIG9uU29ydChzb3J0OiBTb3J0LCBvcmlnaW46ICdkcycgfCAnY2xpY2snKTogdm9pZCB7XG4gICAgY29uc3QgdGFibGUgPSB0aGlzLnRhYmxlO1xuICAgIGNvbnN0IGNvbHVtbiA9IHRhYmxlLmNvbHVtbkFwaS52aXNpYmxlQ29sdW1ucy5maW5kKGMgPT4gYy5pZCA9PT0gc29ydC5hY3RpdmUpO1xuXG4gICAgaWYgKCBvcmlnaW4gIT09ICdjbGljaycgfHwgIWNvbHVtbiB8fCAhY29sdW1uLnNvcnQgKSB7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5ld1NvcnQ6IFBibE5ncmlkU29ydERlZmluaXRpb24gPSB7IH07XG4gICAgICBjb25zdCBzb3J0Rm4gPSB0eXBlb2YgY29sdW1uLnNvcnQgPT09ICdmdW5jdGlvbicgJiYgY29sdW1uLnNvcnQ7XG4gICAgICBpZiAoc29ydC5kaXJlY3Rpb24pIHtcbiAgICAgICAgbmV3U29ydC5vcmRlciA9IHNvcnQuZGlyZWN0aW9uO1xuICAgICAgfVxuICAgICAgaWYgKHNvcnRGbikge1xuICAgICAgICBuZXdTb3J0LnNvcnRGbiA9IHNvcnRGbjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGN1cnJlbnRTb3J0ID0gdGFibGUuZHMuc29ydDtcbiAgICAgIGlmIChjb2x1bW4gPT09IGN1cnJlbnRTb3J0LmNvbHVtbikge1xuICAgICAgICBjb25zdCBfc29ydCA9IGN1cnJlbnRTb3J0LnNvcnQgfHwge307XG4gICAgICAgIGlmIChuZXdTb3J0Lm9yZGVyID09PSBfc29ydC5vcmRlcikge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGFibGUuZHMuc2V0U29ydChjb2x1bW4sIG5ld1NvcnQpO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=